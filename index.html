<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マークシートOCR採点システム</title>
    <meta name="description" content="ブラウザで完結するマークシート自動採点システム">
    <link rel="stylesheet" href="css/style.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <h1>MarkSheet OCR</h1>
            </div>
            <div class="header-actions">
                <button id="helpBtn" class="help-btn" title="マニュアルを開く">
                    <span class="help-icon">?</span> マニュアル
                </button>
            </div>
        </header>

        <main class="main-content">
            <!-- Sidebar / Settings Panel -->
            <aside class="sidebar">
                <div class="panel upload-panel">
                    <h2>ファイル選択</h2>
                    <div class="file-drop-zone" id="dropZone">
                        <input type="file" id="fileInput" accept="application/pdf" hidden>
                        <div class="drop-content">
                            <span class="icon">📄</span>
                            <p>PDFをここにドロップ<br>またはクリックして選択</p>
                        </div>
                    </div>
                    <div class="file-info" id="fileInfo" style="display: none;">
                        <span id="fileName">filename.pdf</span>
                        <span id="pageCount" class="badge">0 ページ</span>
                    </div>
                </div>

                <div class="panel settings-panel">
                    <h2>設定 / 調整</h2>

                    <div class="setting-group">
                        <label>閾値 (二値化)</label>
                        <div class="range-control">
                            <input type="range" id="thresholdSlider" min="0" max="255" value="128">
                            <span id="thresholdValue">128</span>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label>マーク判定感度</label>
                        <div class="range-control">
                            <input type="range" id="sensitivitySlider" min="0.1" max="0.9" step="0.05" value="0.3">
                            <span id="sensitivityValue">30%</span>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label>コントラスト</label>
                        <div class="range-control">
                            <input type="range" id="contrastSlider" min="-100" max="100" value="0">
                            <span id="contrastValue">0</span>
                        </div>
                    </div>

                    <div class="accordion">
                        <details open>
                            <summary>学籍番号エリア</summary>
                            <div class="accordion-content">
                                <div class="input-row">
                                    <label>桁数（列）</label>
                                    <input type="number" id="idDigits" value="7" min="1" max="10">
                                </div>
                                <div class="input-row">
                                    <label>選択肢数（行）</label>
                                    <input type="number" id="idOptions" value="10" min="1" max="20">
                                </div>
                                <button id="setStudentIdAreaBtn" class="btn secondary">エリアを指定</button>
                                <button id="resetStudentIdAreaBtn" class="btn secondary">リセット</button>
                            </div>
                        </details>

                        <details open>
                            <summary>回答エリア（4ブロック）</summary>
                            <div class="accordion-content">
                                <div class="input-row">
                                    <label>使用ブロック数</label>
                                    <select id="numBlocks">
                                        <option value="1">1ブロック</option>
                                        <option value="2">2ブロック</option>
                                        <option value="3">3ブロック</option>
                                        <option value="4" selected>4ブロック</option>
                                    </select>
                                </div>
                                <div class="input-row">
                                    <label>1ブロックあたりの問題数</label>
                                    <input type="number" id="questionsPerBlock" value="25" min="1" max="50">
                                </div>
                                <div class="help-text">
                                    ※ 総問題数 = ブロック数 × 問題数
                                </div>

                                <div class="block-config">
                                    <h4>ブロック1（問1-25）</h4>
                                    <div class="input-row">
                                        <label>有効選択肢数 (1-10)</label>
                                        <input type="number" id="block1Options" value="10" min="1" max="10">
                                    </div>
                                    <p class="help-text">※ 座標は1～0の10個を囲う。これを超える選択肢は無視されます</p>
                                    <button id="setBlock1Btn" class="btn secondary small">マーク領域を指定</button>
                                    <span id="block1Status" class="status-indicator">未設定</span>
                                </div>

                                <div class="block-config">
                                    <h4>ブロック2（問26-50）</h4>
                                    <div class="input-row">
                                        <label>最大選択肢数</label>
                                        <input type="number" id="block2Options" value="10" min="1" max="10">
                                    </div>
                                    <button id="setBlock2Btn" class="btn secondary small">マーク領域を指定</button>
                                    <span id="block2Status" class="status-indicator">未設定</span>
                                </div>

                                <div class="block-config">
                                    <h4>ブロック3（問51-75）</h4>
                                    <div class="input-row">
                                        <label>最大選択肢数</label>
                                        <input type="number" id="block3Options" value="10" min="1" max="10">
                                    </div>
                                    <button id="setBlock3Btn" class="btn secondary small">マーク領域を指定</button>
                                    <span id="block3Status" class="status-indicator">未設定</span>
                                </div>

                                <div class="block-config">
                                    <h4>ブロック4（問76-100）</h4>
                                    <div class="input-row">
                                        <label>最大選択肢数</label>
                                        <input type="number" id="block4Options" value="10" min="1" max="10">
                                    </div>
                                    <button id="setBlock4Btn" class="btn secondary small">マーク領域を指定</button>
                                    <span id="block4Status" class="status-indicator">未設定</span>
                                </div>

                                <button id="resetAllBlocksBtn" class="btn secondary full-width">全ブロックをリセット</button>
                            </div>
                        </details>
                        <div class="setting-group">
                            <details>
                                <summary>現在の設定値（デバッグ用）</summary>
                                <div class="accordion-content">
                                    <textarea id="configOutput" rows="5" readonly
                                        style="width:100%; font-size:10px;"></textarea>
                                    <button id="copyConfigBtn" class="btn small outline full-width">設定値をコピー</button>
                                </div>
                            </details>
                        </div>
                    </div>

                    <div class="panel action-panel">
                        <button id="analyzeFirstPageBtn" class="btn primary full-width" disabled>1枚目を解析（正答設定）</button>
                        <button id="startGradingBtn" class="btn success full-width"
                            style="display: none;">全ページ採点開始</button>
                        <button id="reanalyzePageBtn" class="btn secondary full-width"
                            style="display: none;">現在のページを再解析</button>
                        <button id="exportExcelBtn" class="btn outline full-width"
                            style="display: none;">Excelエクスポート</button>
                        <button id="exportPdfBtn" class="btn outline full-width"
                            style="display: none;">PDF保存（オーバーレイ付）</button>
                    </div>
            </aside>

            <!-- Main Workspace -->
            <section class="workspace">
                <div class="toolbar">
                    <div class="page-nav">
                        <button id="prevPage" disabled>&lt;</button>
                        <span id="pageIndicator">Page 1 / -</span>
                        <button id="nextPage" disabled>&gt;</button>
                        <button id="studentListBtn" class="btn small" title="学籍番号一覧" style="margin-left: 10px;"
                            disabled>≣ 一覧</button>
                    </div>
                    <div class="view-options">
                        <label><input type="checkbox" id="showBinarized"> 二値化表示</label>
                        <label><input type="checkbox" id="showRegions" checked> 認識枠表示</label>
                    </div>
                </div>

                <div class="canvas-container" id="canvasContainer">
                    <canvas id="pdfCanvas"></canvas>
                    <canvas id="overlayCanvas"></canvas> <!-- For drawing regions/results -->
                    <div id="loader" class="loader" style="display: none;"></div>
                </div>

                <div class="results-preview" id="resultsPreview" style="display: none;">
                    <h3>解析結果 <span id="previewPageNum">Page 1</span></h3>
                    <div class="stats">
                        <div class="stat-item"><span class="label">学籍番号:</span> <span class="value"
                                id="resStudentId">-</span></div>
                        <div class="stat-item"><span class="label">マーク数:</span> <span class="value"
                                id="resMarkCount">-</span></div>
                        <div class="stat-item"><span class="label">得点:</span> <span class="value highlight"
                                id="resScore">-</span></div>
                    </div>
                    <div class="answers-grid" id="resAnswersGrid">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Student List Modal -->
    <div id="studentListModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>学籍番号一覧</h2>
            <div class="student-list-container">
                <table id="studentListTable">
                    <thead>
                        <tr>
                            <th>Page</th>
                            <th>ID</th>
                            <th>マーク数</th>
                            <th>複数回答</th>
                            <th>未回答（検出）</th>
                            <th>マーク数不一致</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <script src="js/pdf-handler.js"></script>
    <script src="js/ocr-engine.js"></script>
    <script src="js/grader.js"></script>
    <script src="js/app.js"></script>
</body>

</html>